#Created 2021-06-14
#last edit 2021-06-14

setwd("~/Dropbox/Arabidopsis-eval/R_simul-eval/example_data")
source("~/Dropbox/Arabidopsis-eval/R_simul-eval/source/sim_phyllo_sources.R")
source("~/Dropbox/Arabidopsis-eval/R_simul-eval/source/plot_sequences_sources.R")
source('~/Dropbox/Arabidopsis-eval/R_simul-eval/source/eval_dtw_sources.R')

######################################
#1. Import data (from 3d-explorer)  ##
######################################
#Description:

#Generate all data needed from input files previously generated by the automated script 'test_dtw.R'
seqs=read.csv("Results_3d_explorer_REF.csv")  # read.csv("reference_sequences.csv")
colnames(seqs)[3]="internodes" #fix the capital I for internodes
tests=read.csv("Results_3d_explorer_TEST.csv")  # read.csv("test_sequences.csv")
colnames(tests)[3]="internodes"

#####
#2. run dtw... (outside this script)
#####
#Notes for run
#Activate conda
#source ~/softwares/miniconda3/bin/activate
#conda activate romi
#Then dtw program:
#cd ~/Dropbox/Arabidopsis-eval/dtw/data-analysis
#Modify arabido-test-fab.py -> 3d-explorer_example_result.csv output name
#~/Dropbox/Arabidopsis-eval/dtw/data-analysis$ python arabido-test-fab.py âˆ•!\ ipython no longer works

#####
#3. Import results
#####
data=read.csv("3dexplorer_example_result.csv", header=TRUE)

#####
#4. convert data and plot prediction results
#####
#compatible with multiple PlantIDs:
dtw_results=convert_dtw_results(data, seq.ref = seqs, seq.test = tests)

#####
#5. Use sm-dtw to evaluate a test sequence against a reference sequence
#####
#No ground truth: just plot the result for a plant

#Subset for on plant
#Col0_26_10_2018_A # "Col0_26_10_2018_B" # "Col0_12_10_2018_E" 
testplant_id="Col0_26_10_2018_A"   

testplant.res=subset(dtw_results, PlantID==testplant_id)
testplant.res$PlantID=as.factor(droplevels(testplant.res$PlantID))
testplant.refseq=subset(seqs, PlantID==testplant_id)
testplant.testseq=subset(tests, PlantID==testplant_id)

#Plot
testplant.align=cbind.data.frame(reference=testplant.res$reference, 
                                 modified=testplant.res$test, 
                                 dtw=testplant.res$dtw)
##before realignment:
multiseq_plot(list(testplant.refseq, testplant.testseq),
              id.names = c("1.manual", "2. automated"),
              title=paste0("PlantID: ", testplant_id, "/ raw data"))
##after realignment:
multiseq_plot(list(testplant.refseq, testplant.testseq), align.df = testplant.align , prediction.eval = NULL,
              id.names = c("1.manual", "2.automated"),
              title=paste0("PlantID: ", testplant_id, "/ sm-dtw prediction"))

#Summary result
summarize_align_prediction(testplant.res, testplant.refseq, testplant.testseq, count.as = "number")
