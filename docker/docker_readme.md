# (Draft for a) docker readme

This readme explains:

    - how to download (pull) a pre-built docker image
    - how to run notebooks from a docker container with all the requirements (sm-dtw, R, jupyter notebooks), avoiding multiple and possibly complex install procedures
    - how to solve most current troubles
    - (advanced / for developers): how to build a new /updated docker image

## Requisite
You must install [docker](https://docs.docker.com/desktop/#download-and-install)
## 1. Download the docker image
It should be downloaded automatically when trying to run the docker for the first time
```
docker run -p 8888:8888 -it roboticsmicrofarms/sm-dtw_demo:latest bash
```
**work in progress**: an alternative (and maybe more updated version) of the docker image can be found here:
`fabricebesnard/sm-dtw_demo:latest  bash`

## 2. Using jupyter notebook inside a docker:
### Running the Jupyter notebook:
1. In your **local machine**, create a working directory to store the results generated by the notebook. It will be mounted inside the container, where its name will be "docker_sandbox". The name in you local machine can be identical or different, but keep the name inside the docker to avoid further changes in the notebooks. Sop open a terminal and type: 
```
mkdir docker_sandbox # this folder can be created anywhere in your local machine
cd docker_sandbox # Move into this working directory
```   

2. Start the container:
```
docker run -v $(pwd):/myapp/docker_sandbox -p 8888:8888 -it roboticsmicrofarms/sm-dtw_demo:latest bash
```
*Note*: you can start this command from anywhere in your local machine by correctly mapping the mounted volume in the string before the semi-column (`-v path/in/your/machine:/myapp/docker_sandbox`) 

3. **Inside the container**, serve the notebooks by entering the following command after the running container's prompt (which should be something like: `(dtw) root@aa7632c1fc29:/myapp#`):
```
jupyter notebook Phyllotaxis-sim-eval/notebooks/docker_run --ip 0.0.0.0 --no-browser --allow-root
```
4.  Outside the docker, start your browser
5. enter the url with token:"http://127.0.0.1:8888/?token=....." or directly Ctrl+click on it
6. select the correct kernel (R, dtw or bash, as indicated in the first cell of the notebook)
7. run the notebook !

*some references here*: 
- https://simplernerd.com/docker-jupyter-notebook/
- https://www.thecodeteacher.com/question/55171/python---Access-Jupyter-notebook-running-on-Docker-container
### Troobleshooting
1. Docker external connectivity
example of error message:
```
docker: Error response from daemon: driver failed programming external connectivity on endpoint vibrant_carson (91c770397f27b2a424b77a55f9253a271e64c83a1fdf898b487bfc6808193497): Error starting userland proxy: listen tcp4 0.0.0.0:8888: bind: address already in use.
ERRO[0000] error waiting for container: context canceled
```
   - *Cause of the problem*: another process is currently listening to the 8888 port
   - *solutions*: 
       - Check that other running containers are not listening to the port (`docker ps`) and stop them if necessary (`` )
       - find the process that is listening to the port with the command `lsof -i:8888` and consider killing that process if it is safe (`kill $(lsof -t -i:"8888")`)
       - if nothing works... shut down your computer  (all process connected to the port should be stopped) and re-start !

2. *"When running the docker, R starts directly"*: you probably forgot `bash` at the end of the start command `docker run -it roboticsmicrofarms/sm-dtw_demo:latest bash`

2. Jupyter notebook connection
**Cause of the problem**: another server is running on the same port 
- **solutions**: stop the other process (stopping the web-browser page is not enough, stop the process in the terminal, e.g. another jupyter notebook that could be running)
- 
## 3. Build a new image docker (for developers)
### Build procedure
1. in a git cloned repo of [`Phyllotaxis-sim-eval`](https://github.com/fabfabBesnard/Phyllotaxis-sim-eval), just enter:
```
cd docker
docker build -t imagename:tagname . #(e.g: your_docker_account/repo:latest so that you can push directly. Do not forget the '.' at the end)
```
2. Up-dating the repo `Phyllotaxis-sim-eval` in the docker build
- for testing (e.g. developers), the simplest & fastest is to substitute your local repo of `Phyllotaxis-sim-eval` by mounting it when starting the docker container:
 ```
docker run -v path/to/your/local/repo:/myapp/Phyllotaxis-sim-eval -p 8888:8888 -it roboticsmicrofarms/sm-dtw_phyllotaxis:latest bash # you can add additional volume like a docker_sandbox by entering -v option several times
```
   -However, *if your changes impact the docker itself*, you must either update the main branch by merging you work or modify the `Dockefile` to point to your current branch. Use `--no-cache` option for building and force the update of the git cloned repo.
```
docker build --no-cache -t imagename:tagname .
```

3. testing that everything works inside the docker
Start a docker container from the image in the interactive mode
docker run -it my_new_build:mytag bash

### References about the Dockerfile recipe used for image build:

- install R inside the docker image: https://towardsdatascience.com/creating-sandbox-environments-for-r-with-docker-def54e3491a3
the rocker project: https://github.com/rocker-org/rocker
- Installing R and bash kernels in Jupyter:
https://evodify.com/python-r-bash-jupyter-notebook/
- Install sm-dtw in the docker via miniconda
https://linuxhandbook.com/dockerize-python-apps/